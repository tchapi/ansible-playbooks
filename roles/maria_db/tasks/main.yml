---
- name: Ensure python-soft-prop is installed
  apt:
    pkg: "python-software-properties"
    state: latest
- name: Ensure the key is present
  apt_key:
    id: "0xcbcb082a1bb943db"
    keyserver: keyserver.ubuntu.com
- name: Add repository
  apt_repository:
    repo: 'deb http://ftp.igh.cnrs.fr/pub/mariadb/repo/10.4/debian {{ ansible_distribution_release }} main'
    state: present
    filename: maria_db
- name: Update apt
  apt:
    update_cache: yes
- name: Ensure mariadb is installed
  apt:
    pkg: mariadb-server
    state: latest
- name: Writes the UTF-8 version of the configuration
  copy:
    src: mariadb.cnf
    dest: /etc/mysql/conf.d/mariadb.cnf
    force: no
- name: Remove TokuDB config file
  file:
    path: /etc/mysql/conf.d/tokudb.cnf
    state: absent
- name: Ensure mariadb is running
  service:
    name: mysql
    state: started
    enabled: yes
- name: Sets the root password if needed
  mysql_user:
    name: root
    password: "{{ lookup('password', '/tmp/ansible.password.mysql_root_' + inventory_hostname + ' length=64') }}"
    state: present
- name: Writes /root/.my.cnf with root password
  copy:
    src: my.cnf
    dest: /root/.my.cnf
    mode: 0600
    owner: root
    group: root
- name: Add root password to .my.cnf
  lineinfile:
    dest: /root/.my.cnf
    insertafter: "user=root"
    line: "password={{ lookup('file', '/tmp/ansible.password.mysql_root_' + inventory_hostname) }}"
- name: Create user "backup" if it not present
  mysql_user:
    name: backup
    password: "{{ lookup('password', '/tmp/ansible.password.mysql_backup_' + inventory_hostname + ' length=64') }}"
    priv: "*.*:SHOW DATABASES,SELECT,LOCK TABLES,RELOAD"
    state: present
